<!DOCTYPE html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>SPA</title>
<script>window.onload=()=>{

(()=>{
	Promise.fromIDBRequest ||= req =>
		new Promise((resolve, reject)=>{
			req.onsuccess = ()=>resolve(req.result)
			req.onerror = ()=>reject(req.error)
			req.$reject = reject
		})

	const dbPromises = Object.create(null)
	async function openDB(name, option={}){
		let {version, stores} = option
		if(!dbPromises[name]){
			let req = indexedDB.open(name, version)
			req.onupgradeneeded = () => stores && ungrade(req.result, stores)
			dbPromises[name] = Promise.fromIDBRequest(req)
			req.onblocked = req.$reject //若之前的数据库也通过 openDB 打开，则理论上不会阻塞
			dbPromises[name].catch(err=>{
				delete dbPromises[name]
			})
		}
		let db = await dbPromises[name]
		if(version){
			if(db.version > version) //复用之前打开的 db 时可能发生
				throw new DOMException(`The requested version (${version}) is less than the existing version (${db.version}).`, 'VersionError')
			if(db.version < version){
				delete dbPromises[name]
				return openDB(name, option)
			}
		}
		if(stores && needUpgrade(db, stores)){
			if(db.version == version)
				throw new DOMException('指定的版本与 stores 不匹配')
			//未指定版本，自动升级
			delete dbPromises[name]
			return openDB(name, {
				version: db.version+1,
				stores
			})
		}
		db.onversionchange = ()=>{
			db.close()
			delete dbPromises[name]
		}
		return db
	}
	function ungrade(db, stores){
		//只能在 upgradeneeded 事件使用
		//创建缺少的store（多余的会忽略）
		for(let name of stores)
			if(!db.objectStoreNames.contains(name))
				db.createObjectStore(name)
	}
	function needUpgrade(db, stores){
		for(let name of stores)
			if(!db.objectStoreNames.contains(name))
				return true
	}

	class IDBStorage{
		static checkVersion(dbName, version, storeNames){
			//异步函数
			//若版本吻合，但 storeNames 不匹配则抛出错误
			//若当前版本低于期望的版本，则根据 storeNames 创建缺少的store（多余的会忽略）
			//若当前版本高于期望的版本，则抛出错误
			//成功则返回 db（不建议长期保留该引用）
			return openDB(dbName, {
				version,
				stores: storeNames
			})
		}
		constructor(dbName, storeName){
			//构造前建议先 checkVersion
			this.db = dbName
			this.store = storeName
			openDB(this.db, {stores:[this.store]})
		}
		async getStore(mode){
			let db = await openDB(this.db, {stores:[this.store]})
			return db.transaction(this.store, mode).objectStore(this.store)
		}
		async get(key){
			let store = await this.getStore('readonly')
			return Promise.fromIDBRequest(store.get(key))
		}
		async getMany(keys){
			let store = await this.getStore('readonly')
			let promises = keys.map(key=>Promise.fromIDBRequest(store.get(key)))
			return Promise.all(promises)
		}
		async set(key, val){
			let store = await this.getStore('readwrite')
			return Promise.fromIDBRequest(store.put(val, key))
		}
		async setMany(entries){
			let store = await this.getStore('readwrite')
			let promises = entries.map(entry=>Promise.fromIDBRequest(store.put(entry[1], entry[0])))
			return Promise.all(promises)
		}
		async keys(){
			let store = await this.getStore('readonly')
			return Promise.fromIDBRequest(store.getAllKeys())
		}
		async entries(){
			let store = await this.getStore('readonly')
			let [keys, values] = await Promise.all([
				Promise.fromIDBRequest(store.getAllKeys()),
				Promise.fromIDBRequest(store.getAll())
			])
			return keys.map((key, i)=>[key, values[i]])
		}
		async update(key, updater){
			let store = await this.getStore('readwrite')
			let val = await Promise.fromIDBRequest(store.get(key))
			return Promise.fromIDBRequest(store.put(updater(val), key))
		}
		async del(key){
			let store = await this.getStore('readwrite')
			return Promise.fromIDBRequest(store.delete(key))
		}
		async delMany(keys){
			let store = await this.getStore('readonly')
			let promises = keys.map(key=>Promise.fromIDBRequest(store.delete(key)))
			return Promise.all(promises)
		}
	}

	globalThis.IDBStorage = IDBStorage
})();

async function split(blob){
	async function findNUL(){
		let bfr_size = 256*1024 //每次读取 256KB
		let start = 0
		while(start < blob.size){
			let end = start+bfr_size
			let bfr = await blob.slice(start, end).arrayBuffer()
			let pos = new Uint8Array(bfr).indexOf(0)
			if(pos >= 0)
				return start+pos
			start = end
		}
		throw new Error("no '\\0' found")
	}
    let pos = await findNUL()
    let str = await blob.slice(0, pos).text()
    return {
        meta: JSON.parse(str),
        blob: blob.slice(pos+1)
    }
}
function FileInput(accept){
	var input = document.createElement('input');
	input.type = 'file';
	input.accept = accept;
	return new Promise(resolve=>{
		input.click();
		input.addEventListener('change', ()=>resolve(input.files[0]));
	})
}
function DownloadBlob(file, name){
	var a = document.createElement('a');
	a.download = name;
	a.href = URL.createObjectURL(file);
	a.click();
	URL.revokeObjectURL(a.href);
	a.remove();
}
async function PackageManager(dbName){
	let packagesStore = new IDBStorage(dbName, 'packages')
	let packagesMeta = new IDBStorage(dbName, 'packages-meta')
	return {
		async list(){
			return packagesMeta.entries()
		},
		async addPackage(id, file, meta){
			meta ||= (await split(file)).meta
			await packagesMeta.set(id, meta)
			await packagesStore.set(id, file)
		},
		async removePackage(id){
			await packagesMeta.del(id)
			await packagesStore.del(id)
		},
		async getPackage(id){
			return packagesStore.get(id)
		}
	}
}
var pkgmanager

function isCompatible(ver){
	return ver==0
}
async function loadBlob(b, type){
	switch(type){
		case 'text': return b.text()
		case 'arrayBuffer': return b.arrayBuffer()
		case 'json':{
			let str = await b.text()
			return JSON.parse(str)
		}
		case 'bitmap': return createImageBitmap(b)
		case 'html': case 'xml':{
			let str = await b.text()
			let parser = new DOMParser
			return parser.parseFromString(str, 'text/'+type)
		}
		default: throw new Error('invalid preload type: '+type)
	}
}
async function loadApp(file, addPackage){
	//console.log('loadApp', file)
	let app
	try{
		let {meta, blob} = await split(file)
		let {_ver=0, id, name, icon, files, author, desc, main, require_path} = meta
		if(!isCompatible(_ver))
			throw new Error('版本不兼容')
		let assets = Object.create(null), scripts = Object.create(null)
		let index = 0
		for(let {name, size, type, preload} of files){
			let end = index+size
			if(end > blob.size)
				throw new Error('文件大小不匹配')
			let data = blob.slice(index, end)
			if(type == 'script'){
				scripts[name] = await data.text()
			}else{
				assets[name] = preload ? await loadBlob(data, preload) : data
			}
			index = end
		}
		//console.log(index, blob.size)
		if(index != blob.size)
			throw new Error('文件大小不匹配')
		if(!(main in scripts))
			throw new Error('缺少主模块')
		//认为合法
		if(addPackage)
			pkgmanager.addPackage(id, file, meta)
		app = {id, name, icon, author, desc, assets, scripts, main, require_path}
	}catch(err){
		alert('加载失败。错误信息见控制台。')
		console.error(err)
	}
	app && runApp(app)
}
function runApp(app){
	document.head.innerHTML = ''
	//todo: 设置图标、标题
	document.body.innerHTML = ''
	document.adoptedStyleSheets = []
	let modules = Object.create(null),
		running_modules = Object.create(null)
	function runModule(name){
		if(running_modules[name])
			throw new Error('loop require: '+name)
		let script = app.scripts[name]
		if(script==undefined)
			throw new Error('module not found: '+name)
		
		running_modules[name] = true
		let res = Function('require', script)(makeRequire(name))
		delete running_modules[name]
		modules[name] = res
		return res
	}
	function makeRequire(current){
		let i = current.lastIndexOf('/')
		let dir = i<0 ? '' : current.slice(0, i+1)
		return name => {
			if(typeof name != 'string')
				throw new TypeError('name must be a string')
			if(name[0] == ':')
				return modules[name] //预加载模块
			if(name[0] == '/')
				name = name.slice(1)
			else if(name.startsWith('./'))
				name = dir + name.slice(2)
			else if(app.require_path)
				name = app.require_path +'/'+ name
			name += '.js'
			return name in modules ? modules[name] : runModule(name)
		}
	}
	globalThis.SPA_FRAME = true
	globalThis.require = makeRequire('') //用于调试
	globalThis.Assets = app.assets
	globalThis.applyCSS = applyCSS
	globalThis.importFont = importFont
	modules[':spa'] = {$n, runApp, loadBlob, FileInput, DownloadBlob}
	try{
		runModule(app.main)
	}catch(err){
		alert('启动失败')
		throw err //console.error 无法定位 VM 源码
	}
}

function applyCSS(text, doc=document){
	var ss = new CSSStyleSheet
	ss.replaceSync(text)
	doc.adoptedStyleSheets.push(ss)
	return ss
}
function importFont(family, font, format='opentype'){
	if(typeof font == 'string')
		font = Assets[font]
	if(!(font instanceof Blob))
		throw new Error('Invalid font')
	let url = URL.createObjectURL(font)
	applyCSS(`
	@font-face {
		font-family: "${family}";
		src: url("${url}") format("${format}");
	}`)
}

function $n(tag, data={}){
	let el = document.createElement(tag)
	for(let k in data){
		let v = data[k]
		if(k=='content'){
			if(typeof v=='string')
				el.textContent = v
			else if(v instanceof Array)
				el.append(...v)
			else
				throw new TypeError('invalid content', {cause:v})
		}else if(k=='style' && typeof v=='object'){
			Object.assign(el.style, v)
		}else if(k=='data' && typeof v=='object'){
			Object.assign(el.dataset, v)
		}else{
			el[k] = v
		}
	}
	return el
}

var pkglist
let iconLink = $n('link', {rel:'shortcut icon'})
var defaultIcon = 'data:image/svg+xml,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="48" height="48"><rect x="4" y="4" width="26" height="26" rx="4" fill="#4ae" /><rect x="4" y="34" width="26" height="26" rx="4" fill="#4ae" /><rect x="34" y="4" width="26" height="26" rx="4" fill="#6d8" /><rect x="34" y="34" width="26" height="26" rx="4" fill="#4ae" /></svg>')
async function init(){
	document.head.append(iconLink)
	iconLink.href = defaultIcon
	pkgmanager = await PackageManager('SPA-frame')
	document.body.style.margin = '0'
	
	var packages = await pkgmanager.list()
	var autoRun = getAutoRun(packages)
	if(autoRun){
		pkgmanager.getPackage(autoRun).then(loadApp)
		return
	}

	var container = $n('div', {
		style: {
			width: '100%',
			height: '100%',
			boxSizing: 'border-box',
			border: '3px solid #8cf',
			boxShadow: '0 0 6px #8cf',
			padding: '20px',
			borderRadius: '15px',
			overflowY: 'auto'
		},
		content: [
			$n('div', {
				content: '应用列表',
				style: {
					marginBottom: '10px',
					textAlign: 'center',
					fontSize: '20px',
					fontWeight: 'bold'
				}
			}),
			pkglist = $n('div'),
			$n('button', {
				id: 'load-app-btn',
				content: '+ 加载应用',
				async onclick(){
					let file = await FileInput('.bin')
					loadApp(file, true)
				}
			})
		]
	})
	var outerContainer = $n('div', {
		style: {
			height: '100vh',
			maxWidth: '600px',
			margin: 'auto',
			boxSizing: 'border-box',
			padding: '10px'
		},
		content: [container]
	})
	
	document.body.append(outerContainer)
	displayList(packages)
}
function getAutoRun(packages){
	var search = new URLSearchParams(location.search)
	var autoRun = search.get('auto_run') || localStorage.getItem('spa-auto-run')
	for(let [id, meta] of packages){
		if(id==autoRun)return id
	}
}

function displayList(list){
	pkglist.textContent = list.length ? '' : '暂无应用'
	for(let [id, meta] of list){
		pkglist.append($n('div', {
			className: 'package-item',
			content: [
				$n('img', {
					className: 'icon',
					src: meta.icon || defaultIcon
				}),
				$n('div', {
					content: meta.name,
					style: {flex: '1'}
				}),
				$n('button', {
					content: '启动',
					onclick: ()=>pkgmanager.getPackage(id).then(loadApp)
				}),
				$n('button', {
					content: '删除',
					onclick: ()=>pkgmanager.removePackage(id).then(refreshList)
				}),
				$n('button', {
					content: '导出',
					onclick: ()=>pkgmanager.getPackage(id).then(file=>DownloadBlob(file, id+'.bin'))
				})
			]
		}))
	}
	return pkglist
}
function refreshList(){
	return pkgmanager.list().then(displayList)
}
applyCSS(`
*{
	user-select: none;
}
.package-item{
	border-top: 1px solid #ccc;
	border-bottom: 1px solid #ccc;
	display: flex;
	padding: 5px;
	transition: 0.1s;
	.icon{
		width: 1.5rem;
		height: 1.5rem;
		margin-right: 1rem;
	}
}
.package-item:hover{
	background: #def;
}
#load-app-btn{
	padding-left: 2rem;
	border: none;
	background: none;
	color: #28d;
	font-size: 16px;
	font-weight: bold;
	&:hover{
		color: #2ae;
	}
}`)
init()

}</script>
</head>